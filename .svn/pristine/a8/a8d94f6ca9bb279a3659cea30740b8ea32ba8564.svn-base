*** Settings ***
Documentation     This suite will collect "statistical" data - test execution time needed for single XDR ticket processing
Suite Setup       Setup Suite
Suite Teardown	  Teardown Suite	
Force Tags        matko.sanseovic   ComponentTest  XDR_only   TNZ_supported   #in general, suite is able to work on any test bed that has XDR, DB and AMQ
Resource          ${ROBOT_WORKSPACE_RESOURCE}    #Be aware that variables imported with a resource file are NOT visible in the local Variables table (but in all other local tables)
Resource          ${SUT_RESOURCE}
Resource          ${ROBOT WORKSPACE PATH}/libs/global-keyword-resources/ssh-support/ssh-support-resource.txt
Resource          ${ROBOT WORKSPACE PATH}/libs/global-keyword-resources/db-support/dblib_support-resource.txt
Library           String
Library           SSHLibrary
Library           JMSLibrary
Library           OperatingSystem
Library           org.robot.database.keywords.DatabaseLibrary


*** Variables ***
${XDR_LOG_FILE_PATH}    	/var/log/inew/xdr/5.3.0/inew-mvno-xdr.log
${TAILED_XDR_LOG_FILE}    	ssh_tail_log-xdr.log
${UNIQUE_SEARCH_STRING}		%XdrComponentTest
${SEARCH_DATE_TAG}			2015-02-23
# JMS variables
${INITIAL_CONTEXT_FACTORY}  org.apache.activemq.jndi.ActiveMQInitialContextFactory
${JNDI_PROVIDER_URL}        ${EMPTY}     # SUT variable not available here, value assigned in Suite Setup

*** Keywords ***
Send Ticket To Queue
    [Documentation]    Keyword using JMSLibrary to send text from ticket file to JMS queue
    ...
    ...    		Arguments:
	...            ticket_type
	...         Returns:
    ...            nothing    
	...         Fails:
	...            
    ...    =========================================================
    [Arguments]  ${ticket_type}
	${TICKET}=  OperatingSystem.Get File  ${CURDIR}/tickets/${ticket_type}.txt
	Log   ${TICKET}
    Create Text Message  ${TICKET}
    Send To Queue  ${AMQ-XDR CRCE CDR QUEUE}

Check log
    [Documentation]    Checks the tailed log file created on XDR. 
    ...
    ...    		Arguments:
	...				log_file - file path where log was written
	...             test_type - OK or NOK test type
	...         Returns:
    ...             nothing    
	...         Fails:
	...             in OK case when analysed log file contains string "Exception", then if ${SEARCH_DATE_TAG} is not found, and if XdrComponentTest is not found
	...             in NOK case when "Exception" is not there
	...            
    ...    =========================================================
    [Arguments]    ${log_file}   ${test_type}
	Run Keyword If		'${test_type}' == 'OK'  Should Not Contain    ${log_file}    Exception
	Run Keyword If		'${test_type}' == 'NOK'  Should Contain    ${log_file}    Exception
    Should Contain    ${log_file}    ${SEARCH_DATE_TAG}
    Should Contain    ${log_file}    XdrComponentTest

AnalyseDBTable
    [Documentation]    	Look into the ${table} and check if entry exists.
    ...
    ...    		Arguments:
	...				table - DB table to look for
	...             search key - column name where should be searched
	...             test_type - OK or NOK test type
	...         Returns:
    ...             nothing
	...         Fails:
	...             in OK case when no new row is found in table
	...             in NOK case when there is a new row in the table
    ...
    ...    =========================================================
    [Arguments]    ${table}   ${search_key}   ${test_type}
	@{queryRows}=      	DBLIB Query  select * from ${table} where ${search_key} like '%XdrComponentTest';
	${length}=		   	Get Length  ${queryRows}
	${length_s}=		Convert To String  ${length}
	Run Keyword If		'${test_type}' == 'OK'  Should Be Equal		${length_s}  1
	Run Keyword If		'${test_type}' == 'NOK'  Should Be Equal		${length_s}  0
	
CleanDBTable
    [Documentation]    Runs the sql query  - deletes only selected rows of the ${table} 
    ...
    ...    		Arguments:
	...				table - DB table to look for
	...             search key - column name where should be searched
	...         Returns:
    ...             nothing
	...         Fails:
	...             
    ...    =========================================================
    [Arguments]    ${table}  ${search_key}
    ExecuteSQL  delete from ${table} where ${search_key} like '${UNIQUE_SEARCH_STRING}';

Log The XDR Version
    [Documentation]    Called at suite setup procedure to check if XDR is running and to see which version is there.
    ...
    ...    		Arguments:
	...				nothing
	...         Returns:
    ...             nothing
	...         Fails:
	...             
	...             
    ...
    ...    =========================================================
    Open Connection    ${XDR HOST}
    ${output_login}=    Login    ${XDR USER}    ${XDR PWD}
	Log  ${output_login}
    ${output}=  Execute Command    sudo service inew-mvno-xdr status
	Log    XDR Version and pid: ${output}    console=yes
	Should Contain   ${output}   I-New UMS MVNO - XDR
	Comment   SSHLibrary.Close Connection

Check AMQ Availability
    [Documentation]    Called at suite setup procedure to check if AMQ is UP
    ...
    ...    		Arguments:
	...				nothing
	...         Returns:
    ...             nothing
	...         Fails:
	...             when AMQ listening port is not up, when number of listeners in crce_cdr queue is not bigger then 0
	...             
    ...
    ...    =========================================================
    Open Connection    ${AMQ-XDR HOST}
    ${output_login}=    Login    ${XDR USER}    ${XDR PWD}
	${output}=   Execute Command   netstat -an | grep ${AMQ-SIG PORT}
	Should Contain  ${output}  LISTEN	
    ${output}=  Execute Command    sudo /etc/init.d/${AMQ-XDR SERVICE SCRIPT NAME} query -QQueue=${AMQ-XDR CRCE CDR QUEUE} | grep ConsumerCount
	${count}=  Get Substring  ${output}  16
	Evaluate	0 < ${count}
	Comment   
	SSHLibrary.Close Connection
	
Setup Suite
    ${time}=    Run    date
    Log    	Date and time: ${time}    console=yes
    Log The XDR Version
	Log    	SUT:${SUT_RESOURCE}	console=yes
	Log	   	XDR IP address:${XDR HOST}   console=yes
	Check AMQ Availability
	Log	   	AMQ and consumers are UP  console=yes
    # connect to DB
    Connect To Database    org.postgresql.Driver  jdbc:postgresql://${XDR DB HOST}:${XDR DB PORT}/${XDR DB NAME}   ${XDR DB USER}  ${XDR DB PWD}
    Run    	rm -f ssh_tail_log-xdr.log
    # cleaning DB table(s)
    CleanDBTable    crce_cdr_2015w08  sessionid
	CleanDBTable    crce_cdr  sessionid
	# connect to AMQ
	${JNDI_PROVIDER_URL}=  BuiltIn.Set Variable  tcp://${AMQ-XDR HOST}:${AMQ-SIG PORT}?jms.useAsyncSend=false
	Init Provider  ${INITIAL_CONTEXT_FACTORY}  ${JNDI_PROVIDER_URL}  connect=true  start=true	

Teardown Suite
    Disconnect From Database
	${ssh_connection}=    SSH Login    ${XDR USER}    ${XDR PWD}  ${EMPTY}
	Execute Command  	sudo pkill tail
	Close All Connections

Send Ticket And Analyse
    [Documentation]    General test case skeleton to be executed. Contains all steps for single test case
    ...
    ...    		Arguments:
	...				ticketSignature - variable used for naming tickets and temp XDR log files
	...             affectedDbTable - table used when XDR is processing ticket type sent by the test case
	...             affectedDbTableKeyColumnName - column to be searched for
	...             test_case_type - is it positive (OK) test or negative (NOK
	...         Returns:
    ...             nothing 
	...         Fails:
	...             described in all previously defined keywords that are used within this one
    ...
    ...    =========================================================
    [Arguments]		${ticketSignature}  ${affectedDbTable}  ${affectedDbTableKeyColumnName}  ${test_case_type}
	${ssh_connection}=    SSH Login And Start File Monitor    ${XDR USER}    ${XDR PWD}    ${EMPTY}    ${XDR_LOG_FILE_PATH}    host=${XDR HOST}
    CleanDBTable    ${affectedDbTable}   ${affectedDbTableKeyColumnName}
    Send Ticket To Queue	${ticketSignature}
	${tailed_text}=    SSH Close File Monitor and Logout    ${ssh_connection}
	Check log    ${tailed_text}   ${test_case_type}
    AnalyseDBTable    ${affectedDbTable}   ${affectedDbTableKeyColumnName}    ${test_case_type}
	
Execute Sending MOC ticket
    [Documentation]    Send the MOC XDR ticket and analyse results. It is expected that ticket is processed without errors and database row is added in corresponding table. Test is PASSing when this conditions are fulfilled. \n
    ...    TICKET: 5.3|101|true|1|CRCE|CDR|crce01.tb13|2015-02-23T11:06:11.236+0000|2015-02-22T09:15:50.025+0000|123456XdrComponentTest|1|1|27800|642041999740|PREPAID|ACTIVE||0|NONE|OK||1.2|Charge|BasicSession|1|530992041999740|642041999740|true|642041999415|(network) XdrComponentTest|Local (on-net)|Originating||||Voice|false||(network) XdrComponentTest|2015-02-22T09:15:45.930+0000|0|120000|120000|0|0|1|false|101026|15734486|101026|2|2|Minutes|15|PREPAID|OK||
    ...    =========================================================
	Send Ticket And Analyse		MOC		crce_cdr_2015w08   	sessionid		OK	

Internal Loop
    [Documentation]    General test case skeleton to be executed. Contains all steps for single test case
    ...
    ...    		Arguments:
	...    ==========================================================
	[Arguments] 	${loopIdx}
		: FOR    ${index}   IN RANGE    0    10
		\	${passed}=		Run Keyword And Return Status	Execute Sending MOC ticket
		\  	Log				Index in the 2. loop: ${index}  console=yes
		\	Sleep			${loopIdx}s
		\	${failure}=		Run Keyword If	${passed}=='False'	Evaluate   ${failure}+1
	[Return]	${failure}
	
*** Test Cases ***

Run Statistical Check
    [Documentation]    General test case skeleton to be executed. Contains all steps for single test case
    ...
    ...    		Arguments:
	...    ==========================================================
	${failure}=  Set Variable  0
		: FOR    ${loopIdx}    IN RANGE    0    10
		\	Log		Sitting in first FOR, Loop No.: ${loopIdx}	console=yes
		\	Log		Timeout set to ${loopIdx} secs 	console=yes
		\	${failure}=  Internal Loop  ${loopIdx}
		\	Log  For delay ${loopIdx} we had ${failure} failure(s)  console=yes
